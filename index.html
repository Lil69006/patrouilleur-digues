<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: gap: https://ssl.gstatic.com https://maps.googleapis.com https://hubeau.eaufrance.fr https://docs.google.com https://drive.google.com https://www.vigicrues.gouv.fr https://superviseur.paratronic.com; style-src 'self' 'unsafe-inline'; media-src *;">
    <title>Patrouilleur des Digues</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }
        
        .container {
            padding: 20px;
            max-width: 100%;
        }
        
        .section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            display: block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b894, #00cec9);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #waterChart {
            width: 100%;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .status-bar {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .section {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚨 Patrouilleur des Digues</h1>
    </div>
    
    <div class="container">
        <div class="status-bar">
            📅 <span id="currentDate"></span> | 📍 Lyon - Région Auvergne-Rhône-Alpes
        </div>
        
        <!-- Section Itinéraires -->
        <div class="section">
            <h2>🗺️ Itinéraires Préétablis</h2>
            <a href="https://www.google.fr/maps/dir/177+Bd+Marius+Vivier+Merle,+69003+Lyon,+France/Parking+des+Saules,+All%C3%A9e+des+Vernes,+D%C3%A9cines-Charpieu/@45.7954499,4.9637764,132m/data=!3m1!1e3!4m19!4m18!1m10!1m1!1s0x47f4ea626db2dbe7:0x4e8e6bff6a0fd3d7!2m2!1d4.8576083!2d45.7621445!3m4!1m2!1d4.9146384!2d45.7633939!3s0x47f4c0559bd48f4b:0x264cdce778793a42!1m5!1m1!1s0x47f4c70d4aefe741:0x895fced6a04a3f52!2m2!1d4.9644179!2d45.7955168!3e0?entry=tts" class="btn" target="_blank">
                📍 Itinéraire 1: Triangle → Parking des Saules
            </a>
            <a href="https://maps.app.goo.gl/HFK1aaxCedFAEqu49" class="btn" target="_blank">
                📍 Itinéraire 2: Parking des Saules → Rue Louis Duclos
            </a>
            <a href="https://www.google.fr/maps/dir/45.7946058,4.9235558/45.7834946,4.8944699/@45.7875724,4.9025268,3031m/data=!3m1!1e3!4m2!4m1!3e0?entry=ttu" class="btn" target="_blank">
                📍 Itinéraire 3: Rue Duclos → Rue du Canal
            </a>
        </div>
        
        <!-- Section Formulaires -->
        <div class="section">
            <h2>📋 Formulaires de Visite</h2>
            <a href="https://docs.google.com/spreadsheets/d/1wV50ZsyoDJhcf5Lja5rl1S9TxsOauadMHmyo9slFQGs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                💧 Formulaire "Visite des Eaux Bleues"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1Tsigd9S-qpZfZDQUeLgkA7RIWOTEeDww-NVUIempBMU/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                🏗️ Formulaire "Visite Digue Duclos"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1kBdOQFZrZ260ah69D6JFvHmQXbumgkTNcgMYXsYQoZs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                ⛪ Formulaire "Visite Digue St Jean"
            </a>
            <a href="https://docs.google.com/document/d/1GPb6ZJlW7zHiDn3gHAY1aWq4ladftybg8D_5YIGSgyg/edit?tab=t.0" class="btn btn-warning" target="_blank">
                📝 Vos Notes & Remarques Terrain
            </a>
        </div>
        
        <!-- Section Documents -->
        <div class="section">
            <h2>📚 Documents & Planning</h2>
            <a href="https://drive.google.com/drive/folders/1deKB9iZ3gYfjndRiJY3Dyod8UQw3kzTA" class="btn btn-success" target="_blank">
                📄 Documents d'Astreinte
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1EcmynZSukPIcAvIW_0W6caUiHGLPUTSP/edit?gid=1203425479#gid=1203425479" class="btn btn-success" target="_blank">
                📅 Planning d'Astreinte
            </a>
        </div>
        
        <!-- Section Monitoring -->
        <div class="section">
            <h2>📊 Monitoring Temps Réel</h2>
            <a href="https://www.vigicrues.gouv.fr/territoire/18?bbox=526039.7828146118%2C5728320.102674279%2C557457.0440850101%2C5759737.363944678#dynamic-map" class="btn btn-warning" target="_blank">
                🌊 Site Vigicrues
            </a>
            <a href="https://superviseur.paratronic.com/" class="btn btn-warning" target="_blank">
                🔧 Superviseur Paratronic
            </a>
            
            <div class="chart-container">
                <h3>📈 Niveaux d'eau Pont Morand (48h)</h3>
                <div id="loadingChart" class="loading">🔄 Chargement des données...</div>
                <canvas id="waterChart" style="display:none;"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Affichage de la date actuelle
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
        }
        
        // Fonction pour créer le graphique
        function createWaterChart(data) {
            const canvas = document.getElementById('waterChart');
            const ctx = canvas.getContext('2d');
            
            if (data.length === 0) {
                document.getElementById('loadingChart').textContent = 'Aucune donnée disponible';
                return;
            }
            
            // Préparer les données
            const labels = data.map(item => {
                const date = new Date(item.date_obs);
                return date.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
            });
            
            const values = data.map(item => parseFloat(item.resultat_obs) || 0);
            
            // Configuration du graphique
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const range = maxValue - minValue;
            const padding = 20;
            const chartHeight = canvas.height - 60;
            const chartWidth = canvas.width - 80;
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Style
            ctx.font = '12px Arial';
            ctx.strokeStyle = '#667eea';
            ctx.fillStyle = '#667eea';
            ctx.lineWidth = 2;
            
            // Dessiner le graphique en barres
            const barWidth = chartWidth / data.length;
            
            for (let i = 0; i < data.length; i++) {
                const value = values[i];
                const barHeight = ((value - minValue) / range) * chartHeight;
                const x = 40 + (i * barWidth);
                const y = canvas.height - 40 - barHeight;
                
                // Barre
                ctx.fillStyle = `rgba(102, 126, 234, ${0.3 + (value - minValue) / range * 0.7})`;
                ctx.fillRect(x, y, barWidth - 2, barHeight);
                
                // Bordure
                ctx.strokeStyle = '#667eea';
                ctx.strokeRect(x, y, barWidth - 2, barHeight);
                
                // Valeur au-dessus de la barre
                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toFixed(2) + 'm', x + (barWidth - 2) / 2, y - 5);
            }
            
            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(40, 20);
            ctx.lineTo(40, canvas.height - 40);
            ctx.lineTo(canvas.width - 20, canvas.height - 40);
            ctx.stroke();
            
            // Labels des axes
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // Titre
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Niveau d\'eau (m)', canvas.width / 2, 15);
            
            document.getElementById('loadingChart').style.display = 'none';
            canvas.style.display = 'block';
        }
        
        // Charger les données de l'API
        async function loadWaterData() {
            try {
                const response = await fetch('https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=V300002001&format=json&size=48');
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    // Trier par date (plus récent en premier)
                    const sortedData = result.data.sort((a, b) => new Date(b.date_obs) - new Date(a.date_obs));
                    
                    // Prendre les 48 dernières heures et inverser pour avoir chronologique
                    const last48h = sortedData.slice(0, 48).reverse();
                    
                    createWaterChart(last48h);
                } else {
                    document.getElementById('loadingChart').textContent = 'Aucune donnée disponible pour le Pont Morand';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                document.getElementById('loadingChart').textContent = 'Erreur de chargement des données';
            }
        }
        
        // Initialisation
       async function loadWaterData() {
    try {
        // Utiliser un proxy CORS pour contourner les restrictions
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const targetUrl = 'https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=V300002001&format=json&size=48';
        
        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
        const proxyData = await response.json();
        
        if (proxyData.contents) {
            const result = JSON.parse(proxyData.contents);
            
            if (result.data && result.data.length > 0) {
                // Trier par date (plus récent en premier)
                const sortedData = result.data.sort((a, b) => new Date(b.date_obs) - new Date(a.date_obs));
                
                // Prendre les 48 dernières heures et inverser pour avoir chronologique
                const last48h = sortedData.slice(0, 48).reverse();
                
                createWaterChart(last48h);
            } else {
                document.getElementById('loadingChart').textContent = 'Aucune donnée disponible pour le Pont Morand';
            }
        }
    } catch (error) {
        console.error('Erreur lors du chargement des données:', error);
        
        // Données simulées en cas d'erreur
        const simulatedData = [
            { date_obs: new Date(Date.now() - 47*60*60*1000).toISOString(), resultat_obs: '1.45' },
            { date_obs: new Date(Date.now() - 36*60*60*1000).toISOString(), resultat_obs: '1.52' },
            { date_obs: new Date(Date.now() - 24*60*60*1000).toISOString(), resultat_obs: '1.38' },
            { date_obs: new Date(Date.now() - 12*60*60*1000).toISOString(), resultat_obs: '1.41' },
            { date_obs: new Date().toISOString(), resultat_obs: '1.47' }
        ];
        
        document.getElementById('loadingChart').innerHTML = '⚠️ Données simulées - API temporairement indisponible';
        createWaterChart(simulatedData);
    }
}
