<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Graphique Simple</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .btn { background: #3498db; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        .current-level { background: #e3f2fd; padding: 20px; text-align: center; border-radius: 10px; margin: 20px 0; }
        .current-value { font-size: 28px; font-weight: bold; color: #1976d2; }
        .alert { background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 10px 0; text-align: center; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:nth-child(even) { background: #f8f9fa; }
        .debug { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>🧪 Test Simple - Graphique Hauteur d'Eau</h1>
    
    <div class="container">
        <h2>📊 Station V300002001</h2>
        
        <button onclick="loadRealData()" class="btn">📡 Charger Données Réelles</button>
        <button onclick="loadTestData()" class="btn">🧪 Charger Données Test</button>
        <button onclick="toggleDebug()" class="btn">🔧 Debug</button>
        
        <div id="debug" class="debug" style="display: none;"></div>
        
        <div id="loading" style="text-align: center; padding: 20px; color: #666;">
            Cliquez sur un bouton pour charger des données
        </div>
        
        <div id="alert" class="alert" style="display: none;"></div>
        
        <div id="currentLevel" class="current-level" style="display: none;">
            <div class="current-value" id="currentValue">--</div>
            <div>Dernière mesure</div>
        </div>
        
        <div id="dataTable" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>📅 Date/Heure</th>
                        <th>💧 Hauteur (cm)</th>
                        <th>📊 État</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <div id="stats" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;"></div>
    </div>

    <script>
        var debugMode = false;
        var alertThreshold = 1.60; // 160cm
        
        function log(message) {
            var now = new Date().toLocaleTimeString();
            var debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += '[' + now + '] ' + message + '\n';
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log('[LOG] ' + message);
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debug').style.display = debugMode ? 'block' : 'none';
        }
        
        function showData(data) {
            log('📊 Affichage de ' + data.length + ' points');
            
            document.getElementById('loading').style.display = 'none';
            
            if (data.length === 0) {
                log('❌ Aucune donnée à afficher');
                return;
            }
            
            // Trier par date (plus récent en premier)
            data.sort(function(a, b) { return b.date - a.date; });
            
            // Valeur actuelle
            var latest = data[0];
            var heightCm = (latest.value * 100).toFixed(1);
            
            document.getElementById('currentValue').innerHTML = heightCm + ' cm';
            document.getElementById('currentLevel').style.display = 'block';
            
            // Alerte si nécessaire
            if (latest.value > alertThreshold) {
                document.getElementById('alert').innerHTML = '🚨 ALERTE: Seuil de 160cm dépassé! Niveau: ' + heightCm + 'cm';
                document.getElementById('alert').style.display = 'block';
                document.getElementById('currentValue').style.color = '#c62828';
                log('🚨 ALERTE: Seuil dépassé');
            } else {
                document.getElementById('alert').style.display = 'none';
                document.getElementById('currentValue').style.color = '#1976d2';
            }
            
            // Tableau
            var tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            for (var i = 0; i < Math.min(10, data.length); i++) {
                var item = data[i];
                var row = tableBody.insertRow();
                
                // Date
                var dateCell = row.insertCell(0);
                dateCell.innerHTML = item.date.toLocaleString('fr-FR');
                
                // Valeur
                var valueCell = row.insertCell(1);
                var valueCm = (item.value * 100).toFixed(1);
                valueCell.innerHTML = valueCm;
                valueCell.style.fontWeight = 'bold';
                
                // État
                var statusCell = row.insertCell(2);
                if (item.value > alertThreshold) {
                    valueCell.style.color = '#c62828';
                    statusCell.innerHTML = '🚨 ALERTE';
                    statusCell.style.color = '#c62828';
                    statusCell.style.fontWeight = 'bold';
                } else {
                    valueCell.style.color = '#2e7d32';
                    statusCell.innerHTML = '✅ Normal';
                    statusCell.style.color = '#2e7d32';
                }
            }
            
            document.getElementById('dataTable').style.display = 'block';
            
            // Statistiques
            var values = data.map(function(item) { return item.value; });
            var minValue = Math.min.apply(Math, values);
            var maxValue = Math.max.apply(Math, values);
            var avgValue = values.reduce(function(sum, val) { return sum + val; }, 0) / values.length;
            
            var stats = '📊 Statistiques (' + data.length + ' mesures):<br>';
            stats += 'Min: ' + (minValue * 100).toFixed(1) + 'cm | ';
            stats += 'Max: ' + (maxValue * 100).toFixed(1) + 'cm | ';
            stats += 'Moyenne: ' + (avgValue * 100).toFixed(1) + 'cm<br>';
            stats += 'Dernière mise à jour: ' + new Date().toLocaleString('fr-FR');
            
            document.getElementById('stats').innerHTML = stats;
            document.getElementById('stats').style.display = 'block';
            
            log('✅ Affichage terminé avec succès');
        }
        
        function loadTestData() {
            log('🧪 Chargement des données de test');
            
            var testData = [
                { date: new Date(), value: 1.65, station: 'V300002001' }, // Au-dessus du seuil
                { date: new Date(Date.now() - 1800000), value: 1.58, station: 'V300002001' },
                { date: new Date(Date.now() - 3600000), value: 1.52, station: 'V300002001' },
                { date: new Date(Date.now() - 5400000), value: 1.48, station: 'V300002001' },
                { date: new Date(Date.now() - 7200000), value: 1.45, station: 'V300002001' },
                { date: new Date(Date.now() - 9000000), value: 1.42, station: 'V300002001' },
                { date: new Date(Date.now() - 10800000), value: 1.40, station: 'V300002001' }
            ];
            
            log('✅ ' + testData.length + ' points de test générés');
            showData(testData);
        }
        
        function loadRealData() {
            log('📡 Chargement des données réelles...');
            document.getElementById('loading').innerHTML = '🔄 Chargement API Hub\'Eau...';
            document.getElementById('loading').style.display = 'block';
            
            var apiUrl = 'https://hubeau.eaufrance.fr/api/v2/hydrometrie/obs_elab?code_entite=V300002001&format=json&size=20';
            
            fetch(apiUrl)
                .then(function(response) {
                    log('📡 Réponse API: ' + response.status + ' ' + response.statusText);
                    if (response.status === 200 || response.status === 206) {
                        return response.json();
                    }
                    throw new Error('HTTP ' + response.status);
                })
                .then(function(data) {
                    log('✅ Données reçues: ' + (data.count || 'inconnu') + ' total');
                    log('📊 Éléments dans data.data: ' + (data.data ? data.data.length : 0));
                    
                    if (data.data && data.data.length > 0) {
                        log('📋 Premier élément: ' + JSON.stringify(data.data[0]));
                        
                        var processedData = [];
                        for (var i = 0; i < data.data.length; i++) {
                            var item = data.data[i];
                            
                            var dateField = item.date_obs || item.date_observation || item.timestamp;
                            var valueField = item.resultat_obs || item.resultat_observation || item.valeur;
                            
                            if (dateField && valueField !== undefined) {
                                var dateObj = new Date(dateField);
                                var valueNum = parseFloat(valueField);
                                
                                if (!isNaN(dateObj.getTime()) && !isNaN(valueNum)) {
                                    processedData.push({
                                        date: dateObj,
                                        value: valueNum,
                                        station: 'V300002001'
                                    });
                                }
                            }
                        }
                        
                        log('✅ Données traitées: ' + processedData.length + ' points valides');
                        showData(processedData);
                        
                    } else {
                        throw new Error('Pas de données dans data.data');
                    }
                })
                .catch(function(error) {
                    log('❌ Erreur: ' + error.message);
                    document.getElementById('loading').innerHTML = '❌ Erreur: ' + error.message;
                    
                    // Fallback avec données de test
                    setTimeout(function() {
                        log('🔄 Chargement des données de test en fallback');
                        loadTestData();
                    }, 2000);
                });
        }
        
        log('🚀 Test simple initialisé');
    </script>
</body>
</html>
