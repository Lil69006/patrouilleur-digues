<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suivi Digue Rhône - Pont Morand Lyon</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f7fa;
      color: #333;
    }
    header {
      background-color: #005f99;
      color: white;
      text-align: center;
      padding: 1em;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .btn {
      background-color: #007acc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-right: 10px;
    }
    .btn:hover {
      background-color: #005f99;
    }
    #graphContainer {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    .section-title {
      font-size: 1.3em;
      color: #005f99;
      border-bottom: 2px solid #007acc;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Suivi Digue Rhône - Pont Morand Lyon</h1>
  </header>
  <main>
    <section>
      <h2 class="section-title">Station hydrométrique : V300002001 - Pont Morand Lyon</h2>
      <p><strong>Coordonnées :</strong> 45.7672, 4.8429</p>
      <p><strong>Hauteur d’eau (dernière mesure) :</strong> <span id="lastHeight">Chargement...</span> m</p>
      <p><strong>Date :</strong> <span id="lastDate">Chargement...</span></p>
      <div id="graphContainer">
        <canvas id="hydroGraph"></canvas>
      </div>
      <div style="margin-top: 20px;">
        <button class="btn" id="declareIncidentBtn">Déclaration désordre</button>
        <button class="btn" id="modifIncidentBtn">Modification de la déclaration d’incident</button>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // === Chargement des données hydrométriques ===
    async function loadHydroData() {
      try {
        const response = await fetch(
          "https://hubeau.eaufrance.fr/api/v1/hydrometrie/obs_elab?code_entite=V300002001&grandeur_hydro=H&size=100"
        );
        const data = await response.json();

        const observations = data.data.reverse();
        const labels = observations.map(obs => new Date(obs.date_obs_elab).toLocaleString("fr-FR"));
        const heights = observations.map(obs => obs.resultat_obs_elab);

        document.getElementById("lastHeight").textContent = heights[heights.length - 1].toFixed(2);
        document.getElementById("lastDate").textContent = labels[labels.length - 1];

        new Chart(document.getElementById("hydroGraph"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Hauteur d’eau (m)",
                data: heights,
                borderColor: "#007acc",
                borderWidth: 2,
                fill: false,
              },
              {
                label: "Seuil de vigilance (3.50 m)",
                data: Array(heights.length).fill(3.5),
                borderColor: "orange",
                borderDash: [5, 5],
                fill: false,
              },
              {
                label: "Seuil de danger (4.50 m)",
                data: Array(heights.length).fill(4.5),
                borderColor: "red",
                borderDash: [5, 5],
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      } catch (error) {
        console.error("Erreur lors du chargement des données :", error);
        document.getElementById("lastHeight").textContent = "Erreur";
        document.getElementById("lastDate").textContent = "Erreur";
      }
    }

    loadHydroData();

    // === Bouton Déclaration d’incident ===
    document.getElementById("declareIncidentBtn").addEventListener("click", function () {
      const lienDeclaration = "https://docs.google.com/document/d/1noVZoJXTRZhPxUgIgMmXy1exlvEX4D_l1iKgFVYniVs/edit?usp=drive_link";
      window.open(lienDeclaration, "_blank");
    });

    // === ✅ Bouton Modification de la déclaration d’incident (corrigé) ===
    document.getElementById("modifIncidentBtn").addEventListener("click", function () {
      const lienIncident = "https://docs.google.com/document/d/1noVZoJXTRZhPxUgIgMmXy1exlvEX4D_l1iKgFVYniVs/edit?usp=drive_link";
      window.open(lienIncident, "_blank");
    });
  </script>
</body>
</html>
