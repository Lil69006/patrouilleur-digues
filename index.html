<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: gap: https://ssl.gstatic.com https://maps.googleapis.com https://hubeau.eaufrance.fr https://docs.google.com https://drive.google.com https://www.vigicrues.gouv.fr https://superviseur.paratronic.com https://api.allorigins.win; style-src 'self' 'unsafe-inline'; media-src *;">
    <title>Patrouilleur des Digues</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }
        
        .container {
            padding: 20px;
            max-width: 100%;
        }
        
        .section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            display: block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b894, #00cec9);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .simple-chart {
            width: 100%;
        }
        
        .current-level {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .level-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .level-time {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chart-graph {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .data-table tr:hover {
            background: #e3f2fd;
        }
        
        .level-high {
            color: #d63031;
            font-weight: bold;
        }
        
        .level-normal {
            color: #00b894;
            font-weight: bold;
        }
        
        .level-low {
            color: #fdcb6e;
            font-weight: bold;
        }
        
        .chart-footer {
            font-size: 12px;
            color: #666;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .status-bar {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .section {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .level-value {
                font-size: 28px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö® Patrouilleur des Digues</h1>
    </div>
    
    <div class="container">
        <div class="status-bar">
            üìÖ <span id="currentDate"></span> | üìç Lyon - R√©gion Auvergne-Rh√¥ne-Alpes
        </div>
        
        <!-- Section Itin√©raires -->
        <div class="section">
            <h2>üó∫Ô∏è Itin√©raires Pr√©√©tablis</h2>
            <a href="https://www.google.com/maps/d/edit?mid=1Ss3l_BWgc8yQB2TRXtMxFobuIlsA9PU&usp=drive_link" class="btn" target="_blank">
                üìç Itin√©raire 1: Triangle ‚Üí Parking des Saules
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1FXGfXu9ZXQ6v0BT7j1ganR-BI1smD2E&usp=sharing" class="btn" target="_blank">
                üìç Itin√©raire 2: Parking des Saules ‚Üí Rue Louis Duclos
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1-jG504darrlvK7GmD9JHe41UyJSwP7s&usp=sharing" class="btn" target="_blank">
                üìç Itin√©raire 3: Rue Duclos ‚Üí Rue du Canal
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1TScm_4bW-ogoKfY1x2ySLCAf7y07ysM&usp=drive_link" class="btn" target="_blank">
                üìç Itin√©raire 4: Trajet Suppl√©mentaire 1
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1KTcVxRP5L-GsPFniZyd6sjX-82wl51o&usp=drive_link" class="btn" target="_blank">
                üìç Itin√©raire 5: Trajet Suppl√©mentaire 2
            </a>
        </div>
        
        <!-- Section Formulaires -->
        <div class="section">
            <h2>üìã Formulaires de Visite</h2>
            <a href="https://docs.google.com/spreadsheets/d/1wV50ZsyoDJhcf5Lja5rl1S9TxsOauadMHmyo9slFQGs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                üíß Formulaire "Visite des Eaux Bleues"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1Tsigd9S-qpZfZDQUeLgkA7RIWOTEeDww-NVUIempBMU/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                üèóÔ∏è Formulaire "Visite Digue Duclos"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1kBdOQFZrZ260ah69D6JFvHmQXbumgkTNcgMYXsYQoZs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                ‚õ™ Formulaire "Visite Digue St Jean"
            </a>
            <a href="https://docs.google.com/document/d/1GPb6ZJlW7zHiDn3gHAY1aWq4ladftybg8D_5YIGSgyg/edit?tab=t.0" class="btn btn-warning" target="_blank">
                üìù Vos Notes & Remarques Terrain
            </a>
        </div>
        
        <!-- Section Documents -->
        <div class="section">
            <h2>üìö Documents & Planning</h2>
            <a href="https://drive.google.com/drive/folders/1deKB9iZ3gYfjndRiJY3Dyod8UQw3kzTA" class="btn btn-success" target="_blank">
                üìÑ Documents d'Astreinte
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1EcmynZSukPIcAvIW_0W6caUiHGLPUTSP/edit?gid=1203425479#gid=1203425479" class="btn btn-success" target="_blank">
                üìÖ Planning d'Astreinte
            </a>
        </div>
        
        <!-- Section Monitoring -->
        <div class="section">
            <h2>üìä Monitoring Temps R√©el</h2>
            <a href="https://www.vigicrues.gouv.fr/territoire/18?bbox=526039.7828146118%2C5728320.102674279%2C557457.0440850101%2C5759737.363944678#dynamic-map" class="btn btn-warning" target="_blank">
                üåä Site Vigicrues
            </a>
            <a href="https://superviseur.paratronic.com/" class="btn btn-warning" target="_blank">
                üîß Superviseur Paratronic
            </a>
            
            <div class="chart-container">
                <h3>üìà Station V300002001 - Donn√©es Vigicrues Temps R√©el</h3>
                <div id="loadingChart" class="loading">üîÑ Chargement des donn√©es...</div>
                <div id="waterChart" class="simple-chart" style="display:none;">
                    <div class="current-level" id="currentLevel"></div>
                    <div class="chart-graph" id="chartGraph"></div>
                    <div class="chart-footer" id="chartFooter"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Affichage de la date actuelle
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
        }
        
        // Fonction pour cr√©er le graphique standard
        function createWaterChart(data, stationCode = 'V300002001') {
            if (data.length === 0) {
                document.getElementById('loadingChart').textContent = `Aucune donn√©e disponible pour la station ${stationCode}`;
                return;
            }
            
            // Trier les donn√©es par date (plus r√©cent en premier)
            const sortedData = data.sort((a, b) => new Date(b.date_obs) - new Date(a.date_obs));
            
            // Donn√©es pour affichage (limiter √† 10 points comme demand√©)
            const displayData = sortedData.slice(0, Math.min(10, sortedData.length));
            
            // Valeur la plus r√©cente
            const latestReading = sortedData[0];
            const latestValue = parseFloat(latestReading.resultat_obs);
            const latestDate = new Date(latestReading.date_obs);
            
            // Debug info
            console.log('Affichage des donn√©es:', {
                station: stationCode,
                derni√®re_valeur: latestValue + 'm',
                derni√®re_date: latestDate.toLocaleString('fr-FR'),
                nombre_points: data.length
            });
            
            // Afficher la valeur actuelle
            const currentLevel = document.getElementById('currentLevel');
            currentLevel.innerHTML = `
                <div class="level-value">${latestValue.toFixed(3)} m</div>
                <div class="level-time">
                    üìÖ ${latestDate.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                </div>
                <div style="margin-top: 10px; font-size: 14px;">
                    üìç Station ${stationCode}${latestReading.libelle_station ? ' - ' + latestReading.libelle_station : ''}
                </div>
            `;
            
            // Cr√©er le tableau des donn√©es
            const chartGraph = document.getElementById('chartGraph');
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>üìÖ Date & Heure</th>
                            <th>üíß Niveau (m)</th>
                            <th>üìä √âvolution</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            displayData.forEach((item, index) => {
                const value = parseFloat(item.resultat_obs);
                const date = new Date(item.date_obs);
                const nextValue = index < displayData.length - 1 ? parseFloat(displayData[index + 1].resultat_obs) : value;
                
                // D√©terminer la tendance
                let trend = '';
                if (index < displayData.length - 1) {
                    const diff = value - nextValue;
                    if (diff > 0.005) {
                        trend = 'üìà +' + diff.toFixed(3) + 'm';
                    } else if (diff < -0.005) {
                        trend = 'üìâ ' + diff.toFixed(3) + 'm';
                    } else {
                        trend = '‚û°Ô∏è Stable';
                    }
                }
                
                // Classe de couleur selon le niveau
                let levelClass = 'level-normal';
                if (value > 1.0) levelClass = 'level-high';
                else if (value < 0.3) levelClass = 'level-low';
                
                tableHTML += `
                    <tr>
                        <td>
                            ${date.toLocaleDateString('fr-FR', {
                                weekday: 'short',
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="${levelClass}">${value.toFixed(3)} m</td>
                        <td>${trend}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            chartGraph.innerHTML = tableHTML;
            
            // Calculer les statistiques
            const values = displayData.map(item => parseFloat(item.resultat_obs));
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
            
            // Pied du graphique avec statistiques
            const chartFooter = document.getElementById('chartFooter');
            
            // V√©rifier si ce sont des donn√©es Vigicrues ou Hub'Eau
            const isVigicrues = stationCode.includes('Vigicrues');
            
            chartFooter.innerHTML = `
                üìä <strong>Statistiques sur ${displayData.length} derniers relev√©s:</strong><br>
                Minimum: <strong>${minValue.toFixed(3)} m</strong> | 
                Maximum: <strong>${maxValue.toFixed(3)} m</strong> | 
                Moyenne: <strong>${avgValue.toFixed(3)} m</strong><br>
                <em>Source: ${isVigicrues ? 'API Vigicrues Officielle' : 'API Hub\'Eau'} - Station ${stationCode}</em>
            `;
            
            document.getElementById('loadingChart').style.display = 'none';
            document.getElementById('waterChart').style.display = 'block';
        }
        
        // Script pour g√©rer l'iframe Vigicrues
        function initializeVigicrues() {
            const iframe = document.getElementById('vigicruFrame');
            const errorDiv = document.getElementById('iframeError');
            
            // D√©tecter si l'iframe n'arrive pas √† charger
            iframe.onload = function() {
                try {
                    // Test d'acc√®s (√©chouera si bloqu√© par CORS)
                    iframe.contentDocument;
                    console.log('Vigicrues charg√© avec succ√®s');
                } catch (e) {
                    console.log('Vigicrues bloqu√© par les restrictions CORS');
                    showIframeError();
                }
            };
            
            iframe.onerror = function() {
                console.log('Erreur de chargement Vigicrues');
                showIframeError();
            };
            
            // Timeout de s√©curit√©
            setTimeout(() => {
                try {
                    if (!iframe.contentDocument || iframe.contentDocument.title === '') {
                        showIframeError();
                    }
                } catch (e) {
                    showIframeError();
                }
            }, 10000); // 10 secondes
            
            function showIframeError() {
                iframe.style.display = 'none';
                errorDiv.style.display = 'block';
            }
        }
        async function loadWaterData() {
            const exactApiUrl = 'https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=V300002001&format=json&size=10';
            
            try {
                console.log('üîç Test direct de l\'API:', exactApiUrl);
                
                // Essayer d'abord directement (sans proxy)
                try {
                    const directResponse = await fetch(exactApiUrl);
                    if (directResponse.ok) {
                        const directResult = await directResponse.json();
                        console.log('‚úÖ API directe r√©ussie:', directResult);
                        
                        if (directResult.data && directResult.data.length > 0) {
                            console.log('üìä Donn√©es re√ßues:', {
                                nombre: directResult.data.length,
                                premiere: directResult.data[0],
                                station: directResult.data[0].libelle_station,
                                derniere_mesure: directResult.data[0].resultat_obs + 'm',
                                date: directResult.data[0].date_obs
                            });
                            createWaterChart(directResult.data, 'V300002001');
                            return;
                        }
                    }
                } catch (directError) {
                    console.log('‚ùå API directe √©chou√©e (CORS attendu):', directError.message);
                }
                
                // Essayer avec le proxy CORS
                console.log('üîÑ Tentative avec proxy CORS...');
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(exactApiUrl));
                
                if (!response.ok) {
                    throw new Error(`Proxy response not ok: ${response.status}`);
                }
                
                const proxyData = await response.json();
                console.log('üì° R√©ponse proxy brute:', proxyData);
                
                if (proxyData.contents) {
                    const result = JSON.parse(proxyData.contents);
                    console.log('‚úÖ Donn√©es pars√©es:', result);
                    
                    if (result.data && result.data.length > 0) {
                        console.log('üìä D√©tail des donn√©es re√ßues:');
                        console.table(result.data.map(item => ({
                            Date: new Date(item.date_obs).toLocaleString('fr-FR'),
                            Valeur: item.resultat_obs + 'm',
                            Station: item.libelle_station || 'Non sp√©cifi√©e'
                        })));
                        
                        createWaterChart(result.data, 'V300002001');
                    } else {
                        console.error('‚ùå Aucune donn√©e dans la r√©ponse:', result);
                        document.getElementById('loadingChart').innerHTML = 
                            `‚ö†Ô∏è API accessible mais aucune donn√©e retourn√©e<br>
                             <small>R√©ponse: ${JSON.stringify(result, null, 2)}</small>`;
                    }
                } else {
                    console.error('‚ùå Pas de contenu dans la r√©ponse proxy:', proxyData);
                    document.getElementById('loadingChart').innerHTML = 
                        `‚ö†Ô∏è Proxy accessible mais pas de contenu<br>
                         <small>R√©ponse: ${JSON.stringify(proxyData, null, 2)}</small>`;
                }
                
            } catch (error) {
                console.error('üí• Erreur compl√®te:', error);
                document.getElementById('loadingChart').innerHTML = 
                    `‚ùå Erreur lors de l'acc√®s √† l'API:<br>
                     <code>${exactApiUrl}</code><br>
                     <small>Erreur: ${error.message}</small><br>
                     <em>Consultez la console (F12) pour plus de d√©tails</em>`;
            }
        }
        
        // Initialisation
        document.addEventListener('deviceready', function() {
            updateCurrentDate();
            initializeVigicrues();
            loadWaterData();
            
            // Mise √† jour toutes les 30 minutes
            setInterval(() => {
                updateCurrentDate();
                loadWaterData();
            }, 30 * 60 * 1000);
        });
        
        // Pour les tests dans le navigateur
        if (typeof cordova === 'undefined') {
            updateCurrentDate();
            initializeVigicrues();
            loadWaterData();
            
            setInterval(() => {
                updateCurrentDate();
                loadWaterData();
            }, 30 * 60 * 1000);
        }
        
        // Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service Worker non disponible');
            });
        }
    </script>
    
    <script type="text/javascript" src="cordova.js"></script>
</body>
</html>
