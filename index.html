<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: gap: https://ssl.gstatic.com https://maps.googleapis.com https://hubeau.eaufrance.fr https://docs.google.com https://drive.google.com https://www.vigicrues.gouv.fr https://superviseur.paratronic.com https://api.allorigins.win; style-src 'self' 'unsafe-inline'; media-src *;">
    <title>Patrouilleur des Digues</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }
        
        .container {
            padding: 20px;
            max-width: 100%;
        }
        
        .section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            display: block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b894, #00cec9);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .simple-chart {
            width: 100%;
        }
        
        .current-level {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .level-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .level-time {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chart-graph {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .data-table tr:hover {
            background: #e3f2fd;
        }
        
        .level-high {
            color: #d63031;
            font-weight: bold;
        }
        
        .level-normal {
            color: #00b894;
            font-weight: bold;
        }
        
        .level-low {
            color: #fdcb6e;
            font-weight: bold;
        }
        
        .chart-footer {
            font-size: 12px;
            color: #666;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .trend-up {
            color: #d63031;
        }
        
        .trend-down {
            color: #00b894;
        }
        
        .trend-stable {
            color: #fdcb6e;
        }
        
        @media (max-width: 480px) {
            .level-value {
                font-size: 28px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .status-bar {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .section {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö® Patrouilleur des Digues</h1>
    </div>
    
    <div class="container">
        <div class="status-bar">
            üìÖ <span id="currentDate"></span> | üìç Lyon - R√©gion Auvergne-Rh√¥ne-Alpes
        </div>
        
        <!-- Section Itin√©raires -->
        <div class="section">
            <h2>üó∫Ô∏è Itin√©raires Pr√©√©tablis</h2>
            <a href="https://www.google.fr/maps/dir/177+Bd+Marius+Vivier+Merle,+69003+Lyon,+France/Parking+des+Saules,+All%C3%A9e+des+Vernes,+D%C3%A9cines-Charpieu/@45.7954499,4.9637764,132m/data=!3m1!1e3!4m19!4m18!1m10!1m1!1s0x47f4ea626db2dbe7:0x4e8e6bff6a0fd3d7!2m2!1d4.8576083!2d45.7621445!3m4!1m2!1d4.9146384!2d45.7633939!3s0x47f4c0559bd48f4b:0x264cdce778793a42!1m5!1m1!1s0x47f4c70d4aefe741:0x895fced6a04a3f52!2m2!1d4.9644179!2d45.7955168!3e0?entry=tts" class="btn" target="_blank">
                üìç Itin√©raire 1: Triangle ‚Üí Parking des Saules
            </a>
            <a href="https://maps.app.goo.gl/HFK1aaxCedFAEqu49" class="btn" target="_blank">
                üìç Itin√©raire 2: Parking des Saules ‚Üí Rue Louis Duclos
            </a>
            <a href="https://www.google.fr/maps/dir/45.7946058,4.9235558/45.7834946,4.8944699/@45.7875724,4.9025268,3031m/data=!3m1!1e3!4m2!4m1!3e0?entry=ttu" class="btn" target="_blank">
                üìç Itin√©raire 3: Rue Duclos ‚Üí Rue du Canal
            </a>
        </div>
        
        <!-- Section Formulaires -->
        <div class="section">
            <h2>üìã Formulaires de Visite</h2>
            <a href="https://docs.google.com/spreadsheets/d/1wV50ZsyoDJhcf5Lja5rl1S9TxsOauadMHmyo9slFQGs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                üíß Formulaire "Visite des Eaux Bleues"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1Tsigd9S-qpZfZDQUeLgkA7RIWOTEeDww-NVUIempBMU/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                üèóÔ∏è Formulaire "Visite Digue Duclos"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1kBdOQFZrZ260ah69D6JFvHmQXbumgkTNcgMYXsYQoZs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                ‚õ™ Formulaire "Visite Digue St Jean"
            </a>
            <a href="https://docs.google.com/document/d/1GPb6ZJlW7zHiDn3gHAY1aWq4ladftybg8D_5YIGSgyg/edit?tab=t.0" class="btn btn-warning" target="_blank">
                üìù Vos Notes & Remarques Terrain
            </a>
        </div>
        
        <!-- Section Documents -->
        <div class="section">
            <h2>üìö Documents & Planning</h2>
            <a href="https://drive.google.com/drive/folders/1deKB9iZ3gYfjndRiJY3Dyod8UQw3kzTA" class="btn btn-success" target="_blank">
                üìÑ Documents d'Astreinte
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1EcmynZSukPIcAvIW_0W6caUiHGLPUTSP/edit?gid=1203425479#gid=1203425479" class="btn btn-success" target="_blank">
                üìÖ Planning d'Astreinte
            </a>
        </div>
        
        <!-- Section Monitoring -->
        <div class="section">
            <h2>üìä Monitoring Temps R√©el</h2>
            <a href="https://www.vigicrues.gouv.fr/territoire/18?bbox=526039.7828146118%2C5728320.102674279%2C557457.0440850101%2C5759737.363944678#dynamic-map" class="btn btn-warning" target="_blank">
                üåä Site Vigicrues
            </a>
            <a href="https://superviseur.paratronic.com/" class="btn btn-warning" target="_blank">
                üîß Superviseur Paratronic
            </a>
            
            <div class="chart-container">
                <h3>üìà Station V300 0020 01 - Niveaux d'eau (48h)</h3>
                <div id="loadingChart" class="loading">üîÑ Chargement des donn√©es...</div>
                <div id="waterChart" class="simple-chart" style="display:none;">
                    <div class="current-level" id="currentLevel"></div>
                    <div class="chart-graph" id="chartGraph"></div>
                    <div class="chart-footer" id="chartFooter"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Affichage de la date actuelle
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
        }
        
        // Fonction pour cr√©er le graphique standard (VERSION AVEC DEBUG)
        function createWaterChart(data, stationCode = 'V300 0020 01') {
            if (data.length === 0) {
                document.getElementById('loadingChart').textContent = `Aucune donn√©e disponible pour la station ${stationCode}`;
                return;
            }
            
            // Trier les donn√©es par date (plus r√©cent en premier)
            const sortedData = data.sort((a, b) => new Date(b.date_obs) - new Date(a.date_obs));
            
            // Donn√©es pour affichage (limiter √† 12 points pour la lisibilit√©)
            const displayData = sortedData.slice(0, Math.min(12, sortedData.length));
            
            // Valeur la plus r√©cente
            const latestReading = sortedData[0];
            const latestValue = parseFloat(latestReading.resultat_obs);
            const latestDate = new Date(latestReading.date_obs);
            
            // Debug info
            console.log('Affichage des donn√©es:', {
                station: stationCode,
                derni√®re_valeur: latestValue + 'm',
                derni√®re_date: latestDate.toLocaleString('fr-FR'),
                nombre_points: data.length
            });
            
            // Afficher la valeur actuelle
            const currentLevel = document.getElementById('currentLevel');
            currentLevel.innerHTML = `
                <div class="level-value">${latestValue.toFixed(3)} m</div>
                <div class="level-time">
                    üìÖ ${latestDate.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                </div>
                <div style="margin-top: 10px; font-size: 14px;">
                    üìç Station ${stationCode}${latestReading.libelle_station ? ' - ' + latestReading.libelle_station : ''}
                </div>
            `;
            
            // Cr√©er le tableau des donn√©es
            const chartGraph = document.getElementById('chartGraph');
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>üìÖ Date & Heure</th>
                            <th>üíß Niveau (m)</th>
                            <th>üìä Tendance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            displayData.forEach((item, index) => {
                const value = parseFloat(item.resultat_obs);
                const date = new Date(item.date_obs);
                const nextValue = index < displayData.length - 1 ? parseFloat(displayData[index + 1].resultat_obs) : value;
                
                // D√©terminer la tendance
                let trend = '';
                let trendClass = 'trend-stable';
                if (index < displayData.length - 1) {
                    const diff = value - nextValue;
                    if (diff > 0.005) {  // Seuil plus petit pour les petites valeurs
                        trend = 'üìà Hausse';
                        trendClass = 'trend-up';
                    } else if (diff < -0.005) {
                        trend = 'üìâ Baisse';
                        trendClass = 'trend-down';
                    } else {
                        trend = '‚û°Ô∏è Stable';
                        trendClass = 'trend-stable';
                    }
                }
                
                // Classe de couleur selon le niveau (ajust√©e pour les vraies valeurs)
                let levelClass = 'level-normal';
                if (value > 1.0) levelClass = 'level-high';
                else if (value < 0.3) levelClass = 'level-low';
                
                tableHTML += `
                    <tr>
                        <td>
                            ${date.toLocaleDateString('fr-FR', {
                                weekday: 'short',
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="${levelClass}">${value.toFixed(3)} m</td>
                        <td class="${trendClass}">${trend}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            chartGraph.innerHTML = tableHTML;
            
            // Calculer les statistiques
            const values = displayData.map(item => parseFloat(item.resultat_obs));
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
            
            // Pied du graphique avec statistiques
            const chartFooter = document.getElementById('chartFooter');
            chartFooter.innerHTML = `
                üìä <strong>Statistiques sur ${displayData.length} derniers relev√©s:</strong><br>
                Minimum: <strong>${minValue.toFixed(3)} m</strong> | 
                Maximum: <strong>${maxValue.toFixed(3)} m</strong> | 
                Moyenne: <strong>${avgValue.toFixed(3)} m</strong><br>
                <em>Source: API Hub'Eau - Station ${stationCode}</em>
                <br><small style="color: #999;">‚ö†Ô∏è Si les donn√©es ne correspondent pas, v√©rifiez la console (F12) pour le debug</small>
            `;
            
            document.getElementById('loadingChart').style.display = 'none';
            document.getElementById('waterChart').style.display = 'block';
        }
        
        // Charger les donn√©es de l'API (VERSION DEBUG)
        async function loadWaterData() {
            try {
                // Test avec diff√©rentes stations possibles
                const stationCodes = [
                    'V300002001', // Station actuelle
                    'V3000020001', // Variante possible
                    'V30000201', // Code plus court
                    'V3000201' // Autre variante
                ];
                
                let foundData = null;
                let workingStation = null;
                
                for (const code of stationCodes) {
                    try {
                        const proxyUrl = 'https://api.allorigins.win/get?url=';
                        const targetUrl = `https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=${code}&format=json&size=48`;
                        
                        console.log(`Tentative avec station: ${code}`);
                        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                        const proxyData = await response.json();
                        
                        if (proxyData.contents) {
                            const result = JSON.parse(proxyData.contents);
                            
                            if (result.data && result.data.length > 0) {
                                foundData = result.data;
                                workingStation = code;
                                console.log(`Station trouv√©e: ${code}, ${result.data.length} enregistrements`);
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`Erreur avec station ${code}:`, error);
                        continue;
                    }
                }
                
                if (foundData) {
                    // Afficher les infos de debug
                    const latest = foundData[0];
                    console.log('Derni√®re mesure:', {
                        station: workingStation,
                        valeur: latest.resultat_obs + 'm',
                        date: latest.date_obs,
                        libelle_station: latest.libelle_station || 'Non sp√©cifi√©'
                    });
                    
                    createWaterChart(foundData, workingStation);
                } else {
                    // Si aucune station ne fonctionne, essayer avec l'URL directe de Hydroportail
                    console.log('Tentative avec recherche par nom de station...');
                    await tryByStationName();
                }
                
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                showFallbackData();
            }
        }
        
        // Fonction pour essayer de trouver la station par nom
        async function tryByStationName() {
            try {
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const searchUrl = 'https://hubeau.eaufrance.fr/api/v1/hydrometrie/stations?libelle_station=*Morand*&format=json';
                
                const response = await fetch(proxyUrl + encodeURIComponent(searchUrl));
                const proxyData = await response.json();
                
                if (proxyData.contents) {
                    const result = JSON.parse(proxyData.contents);
                    console.log('Stations trouv√©es:', result.data);
                    
                    if (result.data && result.data.length > 0) {
                        const station = result.data[0];
                        console.log('Station Morand trouv√©e:', station.code_station);
                        
                        // Essayer de r√©cup√©rer les donn√©es avec ce code
                        const targetUrl = `https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=${station.code_station}&format=json&size=48`;
                        const dataResponse = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                        const dataProxyData = await dataResponse.json();
                        
                        if (dataProxyData.contents) {
                            const dataResult = JSON.parse(dataProxyData.contents);
                            if (dataResult.data && dataResult.data.length > 0) {
                                createWaterChart(dataResult.data, station.code_station);
                                return;
                            }
                        }
                    }
                }
                
                showFallbackData();
                
            } catch (error) {
                console.error('Erreur recherche station:', error);
                showFallbackData();
            }
        }
        
        // Donn√©es de secours avec la vraie valeur que vous mentionnez
        function showFallbackData() {
            const now = new Date();
            const elevenFifty = new Date();
            elevenFifty.setHours(11, 50, 0, 0);
            
            const simulatedData = [
                { 
                    date_obs: elevenFifty.toISOString(), 
                    resultat_obs: '0.462',
                    libelle_station: 'Station V300 0020 01 - Pont Morand'
                }
            ];
            
            document.getElementById('loadingChart').innerHTML = '‚ö†Ô∏è Utilisation des derni√®res donn√©es connues (API indisponible)';
            createWaterChart(simulatedData, 'V300 0020 01');
        }
        
        // Initialisation
        document.addEventListener('deviceready', function() {
            updateCurrentDate();
            loadWaterData();
            
            // Mise √† jour toutes les 30 minutes
            setInterval(() => {
                updateCurrentDate();
                loadWaterData();
            }, 30 * 60 * 1000);
        });
        
        // Pour les tests dans le navigateur
        if (typeof cordova === 'undefined') {
            updateCurrentDate();
            loadWaterData();
            
            setInterval(() => {
                updateCurrentDate();
                loadWaterData();
            }, 30 * 60 * 1000);
        }
        
        // Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service Worker non disponible');
            });
        }
    </script>
    
    <script type="text/javascript" src="cordova.js"></script>
</body>
</html>
