<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveillance Digue</title>
    
    <!-- PWA Meta tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Patrouilleur">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }
        
        .container {
            padding: 20px;
            max-width: 100%;
        }
        
        .section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .btn {
            display: block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b894, #00cec9);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }
        
        .emergency-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
            color: white;
            border: 3px solid #fff;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.8); }
            100% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        }

        .status-bar {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }

        .water-level {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .current-level {
            font-size: 48px;
            font-weight: bold;
            color: #1976d2;
            margin: 20px 0;
            text-align: center;
        }

        .info-box {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .info-box-warning {
            background: #ffebee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #d32f2f;
            font-weight: bold;
        }

        .thresholds-legend {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .threshold-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 14px;
        }

        .threshold-color {
            width: 20px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }

        .incident-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .incident-display h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .incident-info {
            color: #333;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .copy-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .section { padding: 15px; }
            .current-level { font-size: 36px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš¨ Surveillance Digue</h1>
    </div>
    
    <div class="container">
        <div class="status-bar">
            ğŸ“… <span id="currentDateTime"></span> | ğŸ“ Lyon - RÃ©gion Auvergne-RhÃ´ne-Alpes
        </div>
        
        <!-- Bouton d'urgence -->
        <div class="section">
            <h2>ğŸš¨ DÃ©claration dÃ©sordre</h2>
            
            <button class="btn emergency-button" style="width: 100%; padding: 20px;" onclick="declareIncident()">
                ğŸš¨ DÃ‰CLARATION DÃ‰SORDRE ğŸš¨
            </button>
            
            <div id="incidentDisplay" class="incident-display">
                <h3>ğŸ“‹ Dernier incident dÃ©clarÃ©</h3>
                <div id="incidentInfo" class="incident-info"></div>
                <button class="copy-btn" onclick="copyIncidentToClipboard()">ğŸ“‹ Copier le rapport</button>
            </div>
            
            <a href="https://docs.google.com/document/d/1noVZoJXTRZhPxUgIgMmXy1exlvEX4D_l1iKgFVYniVs/edit?usp=sharing" 
               class="btn btn-warning" 
               target="_blank"
               id="modifyReportBtn">
                ğŸ“ Modifier le rapport d'incident
            </a>
        </div>
        
        <!-- Monitoring Station V300002001 -->
        <div class="section">
            <h2>ğŸ“Š Station Pont Morand Lyon - V300002001</h2>
            
            <div class="water-level">
                <div style="text-align: center;">
                    <h3>ğŸ’§ Hauteur d'eau</h3>
                    <div id="waterDisplay">
                        <div class="current-level" id="currentLevel">--</div>
                        <div id="lastUpdate" style="color: #666; font-size: 14px;">En attente des donnÃ©es...</div>
                    </div>
                </div>
                
                <!-- LÃ©gende des seuils -->
                <div class="thresholds-legend">
                    <h4 style="margin-bottom: 10px;">ğŸ“ Seuils de surveillance</h4>
                    <div class="threshold-item">
                        <div class="threshold-color" style="background: #7B1FA2;"></div>
                        <span>Seuil de vigilance 1: 160 cm (1.60m)</span>
                    </div>
                    <div class="threshold-item">
                        <div class="threshold-color" style="background: #4CAF50;"></div>
                        <span>Seuil de vigilance 1bis: 280 cm (2.80m)</span>
                    </div>
                    <div class="threshold-item">
                        <div class="threshold-color" style="background: #FFC107;"></div>
                        <span>Seuil de vigilance 2: 360 cm (3.60m)</span>
                    </div>
                    <div class="threshold-item">
                        <div class="threshold-color" style="background: #FF9800;"></div>
                        <span>Seuil de vigilance 3 (niveau de protection): 460 cm (4.60m)</span>
                    </div>
                    <div class="threshold-item">
                        <div class="threshold-color" style="background: #D32F2F;"></div>
                        <span>Seuil de vigilance 4 (niveau de danger): 480 cm (4.80m)</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="loadWaterData()">
                        ğŸ”„ Actualiser les donnÃ©es
                    </button>
                </div>
            </div>
            
            <!-- Liens externes -->
            <a href="https://www.vigicrues.gouv.fr/station/V300002001" class="btn btn-warning" target="_blank">
                ğŸŒŠ Station V300002001 - Vigicrues
            </a>
            
            <a href="https://superviseur.paratronic.com/" target="_blank" class="btn btn-warning">
                ğŸ”§ Superviseur Paratronic (gemapilyon/lyon)
            </a>
        </div>
        
        <!-- ItinÃ©raires -->
        <div class="section">
            <h2>ğŸ—ºï¸ ItinÃ©raires PrÃ©Ã©tablis</h2>
            <a href="https://www.google.com/maps/d/edit?mid=1Ss3l_BWgc8yQB2TRXtMxFobuIlsA9PU&usp=sharing" class="btn" target="_blank">
                ğŸ“ ItinÃ©raire 1: Triangle â†’ Eaux bleues
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1FXGfXu9ZXQ6v0BT7j1ganR-BI1smD2E&usp=sharing" class="btn" target="_blank">
                ğŸ“ ItinÃ©raire 2: Eaux bleues â†’ Digue Duclos
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1-jG504darrlvK7GmD9JHe41UyJSwP7s&usp=sharing" class="btn" target="_blank">
                ğŸ“ ItinÃ©raire 3: Digue Duclos â†’ Digue St Jean
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1TScm_4bW-ogoKfY1x2ySLCAf7y07ysM&usp=drive_link" class="btn" target="_blank">
                ğŸ“ ItinÃ©raire 4: Annexe 4 - Circuit C
            </a>
            <a href="https://www.google.com/maps/d/edit?mid=1KTcVxRP5L-GsPFniZyd6sjX-82wl51o&usp=drive_link" class="btn" target="_blank">
                ğŸ“ ItinÃ©raire 5: Annexe 5 - Circuit D
            </a>
        </div>
        
        <!-- Formulaires -->
        <div class="section">
            <h2>ğŸ“‹ Formulaires de Visite</h2>
            <div class="info-box-warning">
                ğŸ“ Remplir les formulaires de visite en fin de tournÃ©e
            </div>
            <a href="https://docs.google.com/spreadsheets/d/1wV50ZsyoDJhcf5Lja5rl1S9TxsOauadMHmyo9slFQGs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                ğŸ’§ Formulaire "Visite des Eaux Bleues"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1Tsigd9S-qpZfZDQUeLgkA7RIWOTEeDww-NVUIempBMU/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                ğŸ—ï¸ Formulaire "Visite Digue Duclos"
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1kBdOQFZrZ260ah69D6JFvHmQXbumgkTNcgMYXsYQoZs/edit?gid=0#gid=0" class="btn btn-secondary" target="_blank">
                â›ª Formulaire "Visite Digue St Jean"
            </a>
        </div>
        
        <!-- Documents -->
        <div class="section">
            <h2>ğŸ“š Documents & Planning</h2>
            <a href="https://drive.google.com/drive/folders/1deKB9iZ3gYfjndRiJY3Dyod8UQw3kzTA" class="btn btn-success" target="_blank">
                ğŸ“„ Documents d'Astreinte
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1DHt0dOl-bFUE5TxNsH33UVqwarC1mSEv/edit?usp=drive_link&ouid=117931034611088760506&rtpof=true&sd=true" class="btn btn-success" target="_blank">
                ğŸ“… Planning d'Astreinte
            </a>
        </div>
    </div>

    <!-- Script principal -->
    <script>
        // Variables globales
        var lastIncidentReport = '';
        var googleDocUrl = 'https://docs.google.com/document/d/1noVZoJXTRZhPxUgIgMmXy1exlvEX4D_l1iKgFVYniVs/edit?usp=sharing';
        
        // Mise Ã  jour de la date/heure
        function updateDateTime() {
            var now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString('fr-FR');
        }
        
        // Mettre Ã  jour toutes les secondes
        setInterval(updateDateTime, 1000);
        updateDateTime();
        
        // Fonction principale de dÃ©claration d'incident
        function declareIncident() {
            var now = new Date();
            
            // GÃ©nÃ©rer un ID unique avec date et heure
            var incidentId = 'INC-' + 
                now.getFullYear() + 
                ('0' + (now.getMonth() + 1)).slice(-2) +
                ('0' + now.getDate()).slice(-2) + '-' +
                ('0' + now.getHours()).slice(-2) +
                ('0' + now.getMinutes()).slice(-2) +
                ('0' + now.getSeconds()).slice(-2) + '-' +
                Math.random().toString(36).substr(2, 4).toUpperCase();
            
            var incidentDate = now.toLocaleDateString('fr-FR');
            var incidentTime = now.toLocaleTimeString('fr-FR');
            
            console.log('ğŸš¨ DÃ©claration incident:', incidentId);
            
            // Essayer de rÃ©cupÃ©rer la position GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var gpsCoords = position.coords.latitude.toFixed(6) + ', ' + position.coords.longitude.toFixed(6);
                        var gpsLink = 'https://maps.google.com/?q=' + gpsCoords;
                        generateIncidentReport(incidentId, incidentDate, incidentTime, gpsCoords, gpsLink);
                    },
                    function(error) {
                        console.log('Erreur GPS:', error);
                        generateIncidentReport(incidentId, incidentDate, incidentTime, 'Position GPS non disponible', '');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                generateIncidentReport(incidentId, incidentDate, incidentTime, 'GPS non supportÃ©', '');
            }
        }
        
        function generateIncidentReport(id, date, time, gps, gpsLink) {
            var rapport = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            rapport += 'ğŸš¨ RAPPORT D\'INCIDENT - PATROUILLE DIGUE\n';
            rapport += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            
            rapport += 'ğŸ“‹ INFORMATIONS AUTOMATIQUES\n';
            rapport += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            rapport += 'â€¢ ID Incident: ' + id + '\n';
            rapport += 'â€¢ Date: ' + date + '\n';
            rapport += 'â€¢ Heure: ' + time + '\n';
            rapport += 'â€¢ Position GPS: ' + gps + '\n';
            if (gpsLink) {
                rapport += 'â€¢ Lien Maps: ' + gpsLink + '\n';
            }
            rapport += 'â€¢ Zone: Lyon - RÃ©gion Auvergne-RhÃ´ne-Alpes\n';
            rapport += 'â€¢ Station rÃ©fÃ©rence: V300002001 - Pont Morand\n';
            rapport += 'â€¢ Agent: [NOM AGENT]\n\n';
            
            rapport += 'âš ï¸ DESCRIPTION DU DÃ‰SORDRE\n';
            rapport += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            rapport += 'â€¢ Type de dÃ©sordre:\n';
            rapport += '  â˜ Ã‰rosion/Affouillement\n';
            rapport += '  â˜ Fissure/Tassement\n';
            rapport += '  â˜ Glissement/Ã‰boulement\n';
            rapport += '  â˜ Infiltration/Suintement\n';
            rapport += '  â˜ DÃ©bordement\n';
            rapport += '  â˜ Obstacle/EmbÃ¢cle\n';
            rapport += '  â˜ DÃ©gradation d\'ouvrage\n';
            rapport += '  â˜ Autre: _______________\n\n';
            
            rapport += 'â€¢ Localisation prÃ©cise:\n';
            rapport += '  _________________________________\n\n';
            
            rapport += 'â€¢ Description dÃ©taillÃ©e:\n';
            rapport += '  _________________________________\n';
            rapport += '  _________________________________\n';
            rapport += '  _________________________________\n\n';
            
            rapport += 'ğŸ”§ ACTIONS ENTREPRISES\n';
            rapport += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            rapport += '  â˜ SÃ©curisation du pÃ©rimÃ¨tre\n';
            rapport += '  â˜ Information des autoritÃ©s\n';
            rapport += '  â˜ Mise en place signalisation\n';
            rapport += '  â˜ Intervention d\'urgence\n';
            rapport += '  â˜ Surveillance renforcÃ©e\n\n';
            
            rapport += 'ğŸ“¸ PHOTOS\n';
            rapport += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            rapport += '  â˜ Photos prises (nombre: ___)\n';
            rapport += '  â˜ Ã€ joindre au rapport\n\n';
            
            rapport += 'ğŸ“Š NIVEAU D\'URGENCE\n';
            rapport += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            rapport += '  â˜ ğŸ”´ Critique - Intervention immÃ©diate\n';
            rapport += '  â˜ ğŸŸ  Urgent - Intervention sous 24h\n';
            rapport += '  â˜ ğŸŸ¡ Important - Intervention sous 48h\n';
            rapport += '  â˜ ğŸŸ¢ ModÃ©rÃ© - Surveillance renforcÃ©e\n\n';
            
            rapport += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            rapport += 'Signature agent: _________________ \n';
            rapport += 'Date/Heure: ' + date + ' ' + time + '\n';
            rapport += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            
            // Sauvegarder le rapport
            lastIncidentReport = rapport;
            
            // Afficher le rapport
            document.getElementById('incidentInfo').textContent = rapport;
            document.getElementById('incidentDisplay').style.display = 'block';
            
            // Copier automatiquement dans le presse-papier
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(rapport).then(function() {
                    alert('âœ… INCIDENT DÃ‰CLARÃ‰!\n\n' +
                          'ğŸ“‹ ID: ' + id + '\n' +
                          'ğŸ“ GPS: ' + gps + '\n' +
                          'ğŸ“… Date: ' + date + '\n' +
                          'ğŸ• Heure: ' + time + '\n\n' +
                          'âœ… Le rapport a Ã©tÃ© copiÃ© dans le presse-papier.\n' +
                          'ğŸ“ Cliquez sur "Modifier le rapport d\'incident" pour coller et complÃ©ter le rapport dans Google Docs.');
                }).catch(function(err) {
                    console.error('Erreur lors de la copie:', err);
                    showManualCopyInstructions();
                });
            } else {
                showManualCopyInstructions();
            }
            
            // Sauvegarder en localStorage
            saveIncidentToLocalStorage(id, date, time, gps, rapport);
        }
        
        function copyIncidentToClipboard() {
            if (lastIncidentReport && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(lastIncidentReport).then(function() {
                    alert('âœ… Rapport copiÃ© dans le presse-papier!');
                }).catch(function(err) {
                    console.error('Erreur lors de la copie:', err);
                    alert('âŒ Erreur lors de la copie. SÃ©lectionnez et copiez manuellement le texte.');
                });
            } else {
                alert('âŒ Copie non disponible. SÃ©lectionnez et copiez manuellement le texte.');
            }
        }
        
        function showManualCopyInstructions() {
            alert('ğŸ“‹ INCIDENT DÃ‰CLARÃ‰!\n\n' +
                  'âš ï¸ La copie automatique n\'est pas disponible.\n\n' +
                  'Instructions:\n' +
                  '1. SÃ©lectionnez et copiez le rapport affichÃ©\n' +
                  '2. Cliquez sur "Modifier le rapport d\'incident"\n' +
                  '3. Collez le rapport dans le document Google Docs\n' +
                  '4. ComplÃ©tez les informations manquantes');
        }
        
        function saveIncidentToLocalStorage(id, date, time, gps, rapport) {
            try {
                var incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
                incidents.push({
                    id: id,
                    date: date,
                    time: time,
                    gps: gps,
                    rapport: rapport,
                    timestamp: new Date().toISOString()
                });
                
                // Garder seulement les 20 derniers incidents
                if (incidents.length > 20) {
                    incidents = incidents.slice(-20);
                }
                
                localStorage.setItem('incidents', JSON.stringify(incidents));
                localStorage.setItem('lastIncidentId', id);
                console.log('âœ… Incident sauvegardÃ© localement');
            } catch (e) {
                console.error('Erreur sauvegarde localStorage:', e);
            }
        }
        
        // Fonction pour charger les donnÃ©es d'eau
        function loadWaterData() {
            document.getElementById('currentLevel').textContent = 'Chargement...';
            document.getElementById('lastUpdate').textContent = 'RÃ©cupÃ©ration des donnÃ©es...';
            
            // Simuler un chargement (remplacer par l'API quand elle sera disponible)
            setTimeout(function() {
                document.getElementById('currentLevel').textContent = 'Service indisponible';
                document.getElementById('lastUpdate').textContent = 'API temporairement hors ligne';
            }, 2000);
        }
        
        // Charger automatiquement au dÃ©marrage
        window.onload = function() {
            updateDateTime();
            
            // VÃ©rifier s'il y a un dernier incident en mÃ©moire
            try {
                var incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
                if (incidents.length > 0) {
                    var lastIncident = incidents[incidents.length - 1];
                    console.log('Dernier incident trouvÃ©:', lastIncident.id);
                }
            } catch (e) {
                console.error('Erreur lecture localStorage:', e);
            }
        };
    </script>
</body>
</html>
