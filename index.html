<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Hub'Eau</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { background: #3498db; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; }
        .error { background: #ffebee; border-color: #f44336; color: #d32f2f; }
        .success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>🔍 Test API Hub'Eau - Diagnostic</h1>
    
    <div class="test-section">
        <h2>📡 Test des URLs d'API</h2>
        
        <button class="btn" onclick="testAPI1()">
            🧪 Test API V2 (votre URL)
        </button>
        
        <button class="btn" onclick="testAPI2()">
            🧪 Test API V1 (fallback)
        </button>
        
        <button class="btn" onclick="testWithProxy()">
            🧪 Test avec Proxy CORS
        </button>
        
        <button class="btn" onclick="clearLog()">
            🗑️ Effacer le log
        </button>
        
        <div id="testLog" class="log">🔄 Prêt pour les tests...</div>
    </div>
    
    <div class="test-section">
        <h2>📊 Données récupérées</h2>
        <div id="dataDisplay" class="log">Aucune donnée chargée</div>
    </div>

    <script>
        function addLog(message, type) {
            var now = new Date().toLocaleTimeString();
            var logDiv = document.getElementById('testLog');
            var className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            logDiv.innerHTML += '\n[' + now + '] ' + message;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log('[' + type + '] ' + message);
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '🔄 Log effacé...';
        }
        
        function displayData(data, source) {
            var dataDiv = document.getElementById('dataDisplay');
            if (data && data.length > 0) {
                var display = '✅ Source: ' + source + '\n';
                display += '📊 Nombre de points: ' + data.length + '\n\n';
                display += '📋 Premiers éléments:\n';
                
                for (var i = 0; i < Math.min(5, data.length); i++) {
                    var item = data[i];
                    display += '• ' + (item.date_obs || item.date_observation || 'pas de date');
                    display += ' | Valeur: ' + (item.resultat_obs || item.resultat_observation || 'pas de valeur');
                    display += ' | Station: ' + (item.code_entite || item.code_station || 'pas de code') + '\n';
                }
                
                display += '\n📝 Structure complète du premier élément:\n';
                display += JSON.stringify(data[0], null, 2);
                
                dataDiv.innerHTML = display;
                dataDiv.className = 'log success';
            } else {
                dataDiv.innerHTML = '❌ Aucune donnée valide trouvée\n\nRéponse brute:\n' + JSON.stringify(data, null, 2);
                dataDiv.className = 'log error';
            }
        }
        
        // Test 1: API V2 originale
        function testAPI1() {
            addLog('🚀 Test API V2: https://hubeau.eaufrance.fr/api/v2/hydrometrie/obs_elab?code_entite=V300002001&format=json&size=5');
            
            var apiUrl = 'https://hubeau.eaufrance.fr/api/v2/hydrometrie/obs_elab?code_entite=V300002001&format=json&size=5';
            
            fetch(apiUrl)
                .then(function(response) {
                    addLog('📡 Réponse reçue - Status: ' + response.status + ' ' + response.statusText);
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Status: ' + response.status);
                })
                .then(function(data) {
                    addLog('✅ Données JSON parsées avec succès', 'success');
                    addLog('📊 Structure: ' + JSON.stringify(Object.keys(data)));
                    
                    if (data.data) {
                        addLog('✅ Trouvé data.data avec ' + data.data.length + ' éléments', 'success');
                        displayData(data.data, 'API V2 Direct');
                    } else if (Array.isArray(data)) {
                        addLog('✅ Données sous forme de tableau direct', 'success');
                        displayData(data, 'API V2 Direct (array)');
                    } else {
                        addLog('⚠️ Structure de données inattendue', 'error');
                        displayData(data, 'API V2 Direct (unknown structure)');
                    }
                })
                .catch(function(error) {
                    addLog('❌ Erreur API V2: ' + error.message, 'error');
                });
        }
        
        // Test 2: API V1 (fallback)
        function testAPI2() {
            addLog('🚀 Test API V1: https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=V300002001&format=json&size=5');
            
            var apiUrl = 'https://hubeau.eaufrance.fr/api/v1/hydrometrie/observations_tr?code_entite=V300002001&format=json&size=5';
            
            fetch(apiUrl)
                .then(function(response) {
                    addLog('📡 Réponse API V1 - Status: ' + response.status);
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Status: ' + response.status);
                })
                .then(function(data) {
                    addLog('✅ API V1 - Données parsées', 'success');
                    
                    if (data.data) {
                        addLog('✅ API V1 - Trouvé ' + data.data.length + ' éléments', 'success');
                        displayData(data.data, 'API V1');
                    } else {
                        displayData(data, 'API V1 (structure inconnue)');
                    }
                })
                .catch(function(error) {
                    addLog('❌ Erreur API V1: ' + error.message, 'error');
                });
        }
        
        // Test 3: Avec proxy CORS
        function testWithProxy() {
            addLog('🚀 Test avec Proxy CORS');
            
            var apiUrl = 'https://hubeau.eaufrance.fr/api/v2/hydrometrie/obs_elab?code_entite=V300002001&format=json&size=5';
            var proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(apiUrl);
            
            fetch(proxyUrl)
                .then(function(response) {
                    addLog('📡 Proxy CORS - Status: ' + response.status);
                    return response.json();
                })
                .then(function(proxyData) {
                    addLog('✅ Proxy - Données reçues', 'success');
                    
                    if (proxyData.contents) {
                        var data = JSON.parse(proxyData.contents);
                        addLog('✅ Proxy - JSON parsé avec succès', 'success');
                        
                        if (data.data) {
                            displayData(data.data, 'API V2 via Proxy CORS');
                        } else {
                            displayData(data, 'API V2 via Proxy (structure inconnue)');
                        }
                    } else {
                        addLog('❌ Proxy - Pas de contenu dans la réponse', 'error');
                    }
                })
                .catch(function(error) {
                    addLog('❌ Erreur Proxy: ' + error.message, 'error');
                });
        }
        
        // Test automatique au chargement
        setTimeout(function() {
            addLog('🔄 Lancement du test automatique...');
            testAPI1();
        }, 1000);
    </script>
</body>
</html>
